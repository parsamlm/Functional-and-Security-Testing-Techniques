import com.google.gson.Gson
import com.itextpdf.kernel.colors.ColorConstants
import com.itextpdf.kernel.pdf.PdfWriter
import com.itextpdf.layout.Document
import com.itextpdf.layout.element.Cell
import com.itextpdf.layout.element.Paragraph
import com.itextpdf.layout.element.Table
import com.itextpdf.layout.properties.UnitValue
import okhttp3.OkHttpClient
import okhttp3.Request
import java.io.File
import java.io.IOException
import java.util.concurrent.TimeUnit

inline fun <reified T> jsonToKotlinObject(jsonString: String): T {
    return Gson().fromJson(jsonString, T::class.java)
}

inline fun <reified T> kotlinObjectToJson(obj: T): String {
    return Gson().toJson(obj)
}

fun readFromFile(filePath: String): String? {
    return File(filePath).takeIf { it.exists() }?.readText()
}

fun writeToFile(fileName: String, data: String) {
    File(fileName).writeText(data)
}

fun runBashCommand(command: Array<String>): String {
    return Runtime.getRuntime()
        .exec(
            command
        )
        .inputStream
        .bufferedReader()
        .readText()
        .trim()
}

fun getUserInput(message: String): String {
    println(message)
    return readln()
}

fun printVulnerabilities(
    serviceUrl: String? = null,
    type: String,
    version: String,
    vulnerabilities: Set<Vulnerability>
) {
    if (serviceUrl == null) {
        println("Service Type: $type -> ${if (vulnerabilities.isEmpty()) "No vulnerabilities found" else "${vulnerabilities.size} vulnerabilities found"}")
    } else {
        println("Url: $serviceUrl -> ${if (vulnerabilities.isEmpty()) "No vulnerabilities found" else "${vulnerabilities.size} vulnerabilities found"}")
    }
    println("$type (version: $version) vulnerabilities (CVE IDs List):")
    vulnerabilities.forEach { vulnerability ->
        println(vulnerability.cve.id)
    }
    println()
}

class HttpRequestExecutor {
    @Throws(IOException::class)
    fun run(url: String, apiKey: String? = null): String {
        val client = OkHttpClient.Builder().readTimeout(1, TimeUnit.MINUTES).build()
        val request: Request = if (apiKey != null) {
            Request.Builder().url(url).addHeader("apiKey", apiKey).build()
        } else {
            Request.Builder().url(url).build()
        }
        client.newCall(request).execute().use { response ->
            return response.body?.string() ?: ""
        }
    }
}

enum class UsageType {
    MANUAL,
    DOCKER,
    NONE
}

fun askUserForInputType(): UsageType {
    val userInput =
        getUserInput("How do you want to use the script?\n1. Manual\n2. Docker\nEnter the corresponding number:")
    return if (userInput.contentEquals("1")) {
        UsageType.MANUAL
    } else if (userInput.contentEquals("2")) {
        UsageType.DOCKER
    } else {
        UsageType.NONE
    }
}

fun getDirectory(directoryName: String = ""): String {
    return File("").absoluteFile.absolutePath + "/src/main/${directoryName.lowercase()}/"
}

fun checkIfNetworkIsAvailable(): Boolean {
    return try {
        Runtime.getRuntime().exec("ping -c 1 google.com").waitFor() == 0
    } catch (e: IOException) {
        false
    }
}

fun createOutput(manualServices: List<Service>?, dockerServices: Set<ServiceDetails>?, dockerNetworkName: String = "") {

    if (manualServices != null) {
        val writer = PdfWriter(getDirectory("resources") + "output.pdf")
        val pdfDoc = com.itextpdf.kernel.pdf.PdfDocument(writer)
        val doc = Document(pdfDoc)

        for (service in manualServices) {
            val header = Paragraph(
                "Service Information:\n"
            ).setBold().setFontSize(14f)
            doc.add(header)
            val serviceInfo =
                Paragraph()
            // add a link to documnet
            if (service.type == ServiceType.WORDPRESS.toString().lowercase()) {
                serviceInfo.add(" ").add(
                    Paragraph(service.url).setBold().setAction(
                        com.itextpdf.kernel.pdf.action.PdfAction.createURI(service.url)
                    )
                )
            }
            serviceInfo.add(" ${service.type} (version: ${service.version})")

            doc.add(serviceInfo)

            val table = Table(UnitValue.createPercentArray(floatArrayOf(1f, 1f, 1f))).useAllAvailableWidth()

            table.addHeaderCell(Cell().add(Paragraph("Vulnerability").setBold()))
            table.addHeaderCell(Cell().add(Paragraph("Description").setBold()))
            table.addHeaderCell(Cell().add(Paragraph("Severity").setBold()))

            service.vulnerabilities?.forEach { vulnerability ->
                val severity = vulnerability.cve.metrics?.cvssMetricV2?.first()?.baseSeverity ?: " "
                val idCell = Cell().add(Paragraph(vulnerability.cve.id))
                when (severity) {
                    "HIGH" -> idCell.setBackgroundColor(ColorConstants.RED, 0.3f)
                    "MEDIUM" -> idCell.setBackgroundColor(ColorConstants.ORANGE, 0.3f)
                    "LOW" -> idCell.setBackgroundColor(ColorConstants.GREEN, 0.3f)
                    else -> idCell.setBackgroundColor(ColorConstants.WHITE)
                }
                table.addCell(idCell)
                val descriptionCell = Cell().add(Paragraph(vulnerability.cve.descriptions?.first()?.value))
                when (severity) {
                    "HIGH" -> descriptionCell.setBackgroundColor(ColorConstants.RED, 0.3f)
                    "MEDIUM" -> descriptionCell.setBackgroundColor(ColorConstants.ORANGE, 0.3f)
                    "LOW" -> descriptionCell.setBackgroundColor(ColorConstants.GREEN, 0.3f)
                    else -> descriptionCell.setBackgroundColor(ColorConstants.WHITE)
                }
                table.addCell(descriptionCell)

                val severityCell = Cell().add(Paragraph(severity))

                when (severity) {
                    "HIGH" -> severityCell.setBackgroundColor(ColorConstants.RED, 0.3f)
                    "MEDIUM" -> severityCell.setBackgroundColor(ColorConstants.ORANGE, 0.3f)
                    "LOW" -> severityCell.setBackgroundColor(ColorConstants.GREEN, 0.3f)
                    else -> severityCell.setBackgroundColor(ColorConstants.WHITE)
                }

                table.addCell(severityCell)
            }

            doc.add(table)

            doc.add(Paragraph("\n"))
        }
        doc.close()
    } else if (dockerServices != null) {
        val writer = PdfWriter(getDirectory("resources") + "output.pdf")
        val pdfDoc = com.itextpdf.kernel.pdf.PdfDocument(writer)
        val doc = Document(pdfDoc)
        doc.add(Paragraph("Docker Network: $dockerNetworkName\n"))
        for (service in dockerServices) {
            val serviceInfo =
                Paragraph(
                    "Service Information:\n${service.type} (version: ${service.version})"
                )
            doc.add(serviceInfo)

            val table = Table(UnitValue.createPercentArray(floatArrayOf(1f, 1f, 1f))).useAllAvailableWidth()

            table.addHeaderCell(Cell().add(Paragraph("Vulnerability").setBold()))
            table.addHeaderCell(Cell().add(Paragraph("Description").setBold()))
            table.addHeaderCell(Cell().add(Paragraph("Severity").setBold()))

            service.vulnerabilities?.forEach { vulnerability ->
                table.addCell(Cell().add(Paragraph(vulnerability.cve.id)))
                table.addCell(Cell().add(Paragraph(vulnerability.cve.descriptions?.first()?.value)))
                table.addCell(
                    Cell().add(
                        Paragraph(
                            vulnerability.cve.metrics?.cvssMetricV2?.first()?.baseSeverity ?: " "
                        )
                    )
                )
            }
            doc.add(table)

            doc.add(Paragraph("\n"))
        }
        doc.close()
    } else {
        println("")
    }

}