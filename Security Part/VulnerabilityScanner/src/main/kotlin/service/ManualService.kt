package service

import helper.HttpRequestExecutor
import helper.executeBashCommandAndReturnOutput
import org.jsoup.Jsoup
import java.sql.Connection
import java.sql.DriverManager

private fun fetchWebsiteContentAsString(url: String): String =
    runCatching { HttpRequestExecutor().run(url) }.getOrDefault("")

fun fetchWordPressVersionFromMetaTag(url: String?): Map<String, String?> {
    val content = Jsoup.parse(fetchWebsiteContentAsString(url ?: return mapOf("version" to null)))
        .select("meta[name=generator]").first()?.attr("content")
    return mapOf("version" to content?.split(" ")?.get(1))
}

var connection: Connection? = null

fun establishMySQLConnection(
    url: String = "jdbc:mysql://localhost:3306/",
    username: String = "root",
    password: String = ""
) {
    connection = DriverManager.getConnection(url, username, password)
}

fun closeMySQLConnection() = connection?.close()

fun getMySQLVersion(): String {
    establishMySQLConnection()
    val version = connection?.createStatement()?.executeQuery("SELECT VERSION()")?.run {
        next()
        getString(1)
    } ?: ""
    closeMySQLConnection()
    return version.split("-")[0]
}

fun fetchApacheVersionFromBashCommand(): String =
    executeBashCommandAndReturnOutput(arrayOf("httpd", "-v")).split("\n")[0].split(":")[1].split("/")[1].split(" ")[0]

enum class ServiceType {
    WORDPRESS,
    APACHE,
    MYSQL
}